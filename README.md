# Тестовое задание

Использовал PostGIS для поиска по радиусу. Написаны тесты. Документация доступна
по адресу `/api/docs`.

Для конвертации между типами PostGIS/Python (от базы возвращаются бинарные,
записываются текстовые данные) используется `shapely`. Для генерации миграций
для `alembic` используется `GeoAlchemy2`.

Для поиска по организациям используется полнотекстовый поиск с комбинацией
`tsvector` + trigram similarity с настраиваемым порогом совпадения.

Аутентификация чрезвычайно простая. Ключ API ставится через переменные среды,
проверяется для всех эндпоинтов кроме `/docs` в middleware.

Для управления соединениями базы данных используется библиотека
[based](https://github.com/ansipunk/based), которую я написал сам. Она еще не
адаптирована под PostGIS, поскольку с ним мне еще не приходилось сталкиватся, но
асинхронно менеджит соединения, транзакции и коннекшн пулы для `aiosqlite`,
`psycopg3` и `aiomysql`.

100%-ное покрытие тестами с `pytest`, `pytest-xdist`, `pytest-cov`,
`pytest-asyncio` и `pytest-mock`. Стиль кода проверяется с помощью `ruff`.

Установка, миграция, тестовые запуски и многое другое происходит в `Makefile`.
Не использовал `poetry`, потому что незачем. Версии используемых напрямую
библиотек и так запинены. Проверять, вышли ли обновления на библиотеки, можно
командой `make outdated`.

### Что еще можно было бы сделать

- `PUT` методы для зданий, категорий и организаций.
- Сохранение API ключей в базе, чтобы их менять динамически без рестарта
  приложения.
- Поиск по указанной области. Это довольно тривиально с PostGIS. Задача не
  уточняет конкретных требований по прямоугольнику, но там, в целом, можно
  выбрать любую фигуру.
- Снять ограничения на уровень вложенности категорий организаций.
- Написать пайплайны, чтобы выполнять тесты, проверять покрытие и прогонять
  линтер на CI/CD.
- Использовать сторонний API для поиска и нормализации адресов.
- Поставить UNIQUE constraint на activity.name + activity.parent_id.
- Переместить проверку уровня вложения в триггер PostgreSQL.
- Сделать один общий эндпоинт для фильтрации организаций сразу по зданиям,
  точкам и типам деятельности.
- Добавить пагинацию.
- Эндпоинт для получения типа деятельности и наследников.
- Я изначально забыл про телефонные номера, быстро сделал их полем в таблице
  организаций. Следовало сделать либо таблицу one-to-many, либо хранить в
  массиве в таблице организаций.
- Сделать валидацию и нормализацию телефонных номеров.
- Хранить таймстемпы создания и изменения строк в базе.
